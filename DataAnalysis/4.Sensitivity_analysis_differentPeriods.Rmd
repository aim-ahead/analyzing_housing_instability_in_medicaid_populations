---
title: "Sensitivity analysis: how the results would look like if the periods are different?"
output: html_document
---

# Load the required R libraries
```{r}
.libPaths(c('/home/rstudio-user/studies/lib/', .libPaths()))
#install.packages("mappings", lib = "/home/rstudio-user/studies/lib/")
library(table1)
library(dplyr)
library(lubridate)
library(ggplot2)
library(mappings)
library(officer)
```

# Read the files extracted from the db
These files are exports from the tables:
- f1_all_payors_housingInstability_demographics_rownum122212.txt
- f1_all_payors_housingInstability_encounter_rownum414458.txt

The inclusion criteria has been:
- patients that experienced housing insecurity (SDH concepts)
- older than 18 years old
- time period: 2016 to 2022
```{r}
all_pop_demographic <- read.delim("reviewSQLoutputs/f1_all_payors_housingInstability_demographics_screened_rownum31288.txt", header = TRUE, sep = ",")
all_pop_encounters <- read.delim("reviewSQLoutputs/f1_all_payors_housingInstability_encounter_screened_rownum44660.txt", header = TRUE, sep = ",")
```

# Identify Medicaid ones
```{r}
medicaid_encounters <- all_pop_encounters %>%
  dplyr::filter( PAYOR_TYPE_RESEARCH == "Medicaid") %>%
  dplyr::mutate( year = as.numeric(sapply(strsplit( as.character(start_date), "[-]"), "[", 1))) %>%
  dplyr::filter( year %in% c(2018, 2019, 2020, 2021))

medicaid_encounters %>% group_by( year ) %>% summarise( pat = n_distinct( patient_num ))
```

# Define Periods
- Pre-pandemic as 2018-2019
- Post pandemic as 2020-2021
We identify common patients in both periods and filter them out of the dataset. 
```{r}
prePandemic_population <- medicaid_encounters %>%
  dplyr::filter( year %in% c(2016, 2017, 2018, 2019) )

postPandemic_population <- medicaid_encounters %>%
  dplyr::filter( year %in% c(2020, 2021) )
```

Identify and remove patients that are in both periods, pre and post pandemic 
```{r}
# first we identify which are the patients in both periods
common <- prePandemic_population[ prePandemic_population$patient_num %in% postPandemic_population$patient_num,  "patient_num"]

print(paste0("We are excluding ", length(unique(common)), " patients at this step on the analysis"))

# then we remove them from the overall population using the filter
# we create a new column with the flag, pre or post pandemic for each patient
# finally, with the lef_join we add the encounter numbers with the dates
overall_population <- all_pop_demographic %>%
  dplyr::filter( ! PATIENT_NUM %in% common ) %>%
  dplyr::filter( PATIENT_NUM %in% prePandemic_population$patient_num | PATIENT_NUM %in% postPandemic_population$patient_num) %>%
  dplyr::mutate( pandemic_period = ifelse(PATIENT_NUM %in% prePandemic_population$patient_num, "pre-pandemic", "post-pandemic")) 
  

print(paste0("We have a total of ", length(unique(overall_population$PATIENT_NUM)), " patients at this step on the analysis"))
summary(as.factor(overall_population$pandemic_period))
```

# Identify the patients with missing information and exlcude them. 
Create a clean dataset excluding rows with missing values
```{r}
# Create a clean dataset excluding rows with missing values
overall_population_clean <- overall_population[ complete.cases( overall_population), ]

print(paste0("We have a total of ", length(unique(overall_population_clean$PATIENT_NUM)), " patients at this step on the analysis"))
```

# Add first_encounter date
```{r}
postPandemic_population <- postPandemic_population %>%
  dplyr::filter( ! patient_num %in% common) %>%
  dplyr::mutate( date = sapply(strsplit( as.character(start_date), " "), '[', 1)) %>%
  dplyr::group_by( patient_num ) %>%
  dplyr::summarise( encounter_date = min( date ))

prePandemic_population <- prePandemic_population %>%
  dplyr::filter( ! patient_num %in% common) %>%
  dplyr::mutate( date = sapply(strsplit( as.character(start_date), " "), '[', 1)) %>%
  dplyr::group_by( patient_num ) %>%
  dplyr::summarise( encounter_date = min( date ))

firstEncounter <- rbind( prePandemic_population, postPandemic_population)
```


# Recode different columns into meaningful categories

## Age groups
First we estimate the age with the date of first encounter and the birth year. 
Then we categorize the age in 5 different groups. 
```{r}
overall_population_age <- overall_population_clean %>%
  dplyr::left_join( firstEncounter, by=c("PATIENT_NUM"="patient_num")) %>%
  dplyr::mutate( birth_year = as.Date(sapply(strsplit( as.character(BIRTH_DATE), " "), "[", 1), format = "%Y-%m-%d")) %>%
  dplyr::mutate( age = round(floor( as.numeric(as.Date(encounter_date, format = "%Y-%m-%d")) - as.numeric(as.Date(birth_year, format = "%Y-%m-%d")))/365.25)) %>%
  dplyr::mutate( age_group = ifelse( age >= 18 & age < 25, "18-24", 
                                     ifelse( age >= 25 & age < 35, "25-34", 
                                             ifelse( age >= 35 & age < 45, "35-44", 
                                                     ifelse( age >= 45 & age < 65, "45-64", 
                                                             ifelse( age >= 45 & age < 65, "45-64", 
                                                                     ifelse( age >= 65, "65+ over", "other")))) )))
```

## Recode for: Race & Marital status & Sex & language
In this step we recode the variables and we also filter out the patients with "other" for gender, due to the low values (<10), for privacy reasons. 

```{r}
overall_population_categorized <- overall_population_age %>%
  dplyr::mutate( race = ifelse( RACE_CD == "DEM|RACE:01", "American Indian Alaskan Native",   
          ifelse( RACE_CD == "DEM|RACE:02", "Asian",
            ifelse( RACE_CD == "DEM|RACE:03", "Black African American",
              ifelse( RACE_CD == "DEM|RACE:04", "Native Hawaiian or Other Pacific Islander",
                  ifelse( RACE_CD == "DEM|RACE:05", "White",
                    ifelse( RACE_CD == "DEM|RACE:06", "MultipleRace", "other"))))))) %>%
  dplyr::mutate( hispanic = ifelse( HISPANIC_CD == "DEM|HISPANIC:Y", "YES",   
                                    ifelse( HISPANIC_CD == "DEM|HISPANIC:N", "NO", "other"))) %>%
  dplyr::mutate(maritalstatus = ifelse(MARITAL_STATUS_CD == "DEM|MARITAL:Single", "Single", 
      ifelse(MARITAL_STATUS_CD == "DEM|MARITAL:Married", "Married",
        ifelse(MARITAL_STATUS_CD == "DEM|MARITAL:Significant Other", "Significant Other",
          ifelse(MARITAL_STATUS_CD == "DEM|MARITAL:Domestic Partner", "Significant Other",
              ifelse(MARITAL_STATUS_CD == "DEM|MARITAL:Divorced", "Divorced",
                 ifelse(MARITAL_STATUS_CD == "DEM|MARITAL:Separated", "Separated", 
                    ifelse(MARITAL_STATUS_CD == "DEM|MARITAL:Widowed", "Widowed", "other")))))))) %>%
  dplyr::mutate(sex = ifelse(SEX_CD == "DEM|SEX:F", "Female", 
              ifelse(SEX_CD == "DEM|SEX:M", "Male", "other"))) %>%
  dplyr::filter(sex != "other")  %>%
  dplyr::mutate( language = ifelse( LANGUAGE_CD == "ENG",  "English", 
                                ifelse( LANGUAGE_CD == "SPA", "Spanish", "other")))
```

We create an extrac column that contains both, the ethnicity (hispanic: yes/no and the race)
```{r}
overall_population_categorized <- overall_population_categorized %>%
  dplyr::mutate( eth_race = paste0( ifelse( hispanic == "YES", "hispanic", ifelse(hispanic== "NO", "Non-Hispanic", "Other")), " ", race ))
```

We check again for missing values and we save the recoded and clean data to create table 1. 
```{r}
#remove potential NAs
overall_population_categorized <- na.omit(overall_population_categorized)
#save the table as backup
save( overall_population_categorized, file = "/home/rstudio-user/studies/Research-Fellowship-jovita-murillo/overall_population_categorized_sensitivity.RData")
```

# Create a first version of table 1
```{r}
column_order <- mappings::mapping(c("pre-pandemic", "post-pandemic"))
t1_withOverall <- table1(~ age_group + sex + hispanic + race + eth_race + language + CURRENT_FPL_CD + HOMELESS_CD + maritalstatus + 
         RURAL_CD | column_order(pandemic_period), 
       data = overall_population_categorized, caption = "Table 1. Housing instability before and after pandemic (with overall")

write.table(t1_withOverall, file= "outputs/t1_withOverall_from2018to2021.txt", col.names = TRUE, row.names = TRUE, sep = "\t", quote = FALSE)
```


### Save table as word document
```{r}
doc <- read_docx()

# Add content to the document
doc <- doc %>%
  officer::body_add_par("Table 1. Housing instability before and after pandemic (with overall") %>%
  officer::body_add_table(  as.data.frame( t1_withOverall ) )

# Save the document
print(doc, target = "outputs/t1_withOverall_from2018to2021.docx")
```

## Create a second version of the table adding the p-value
```{r}
# add p-value to the table
pvalue <- function(x, ...) {
  # Construct vectors of data y, and groups (strata) g
  y <- unlist(x)
  g <- factor(rep(1:length(x), times=sapply(x, length)))
  if (is.numeric(y)) {
    # For numeric variables, perform a standard 2-sample t-test
    p <- t.test(y ~ g)$p.value
  } else {
    # For categorical variables, perform a chi-squared test of independence
    p <- chisq.test(table(y, g))$p.value
  }
  # Format the p-value, using an HTML entity for the less-than sign.
  # The initial empty string places the output on the line below the variable label.
  
  
  c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

table1_output <- table1(~ age_group + sex + hispanic + race + eth_race + language + CURRENT_FPL_CD  + HOMELESS_CD + maritalstatus + 
         RURAL_CD | column_order(pandemic_period), 
       data = overall_population_categorized,  overall=F, extra.col=list(`P-value`=pvalue), caption = "Table 1. Housing instability before and after pandemic (with p-value")

write.table(table1_output, file= "outputs/t1_withPvalues_periodfrom2018to2021.txt", col.names = TRUE, row.names = TRUE, sep = "\t", quote = FALSE)
```

### Save table as word document
```{r}
doc <- read_docx()

# Add content to the document
doc <- doc %>%
  officer::body_add_par("Table 1. Housing instability before and after pandemic (with p-value)") %>%
  officer::body_add_table(  as.data.frame( table1_output ) )

# Save the document
print(doc, target = "outputs/t1_withPvalues_from2018to2021.docx")
```

